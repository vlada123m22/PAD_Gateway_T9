global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    timeout connect 10s
    timeout client  30s
    timeout server  30s
    timeout check   5s
    option  tcplog

# MongoDB Replica Set Proxy (User & Game Services)
frontend mongodb-frontend
    bind *:27017
    default_backend mongodb-backend

backend mongodb-backend
    balance leastconn
    option tcp-check
    # Check if MongoDB is primary and can accept writes
    tcp-check connect
    tcp-check send-binary 3a000000 # MongoDB handshake
    tcp-check send-binary FFFFFFFF # requestId
    tcp-check send-binary 00000000 # responseTo
    tcp-check send-binary d4070000 # opCode (OP_QUERY)
    tcp-check send-binary 00000000 # flags
    tcp-check send-binary 61646d696e2e # "admin.$cmd"
    tcp-check send-binary 2463616d6400 #
    tcp-check send-binary 00000000 # numberToSkip
    tcp-check send-binary FFFFFFFF # numberToReturn
    tcp-check expect binary 69734d617374657200 # "isMaster"

    # Primary gets higher weight for writes
    server mongo-primary mongo-primary:27017 check inter 3000 rise 2 fall 3 weight 100
    server mongo-secondary-1 mongo-secondary-1:27017 check inter 3000 rise 2 fall 3 weight 50 backup

# Stats page
listen stats
    bind *:8405
    stats enable
    stats uri /stats
    stats refresh 5s




