services:
  service_discovery:
    image: nadea39/service-discovery:v1.2.0
    container_name: service_discovery_container
    ports:
      - "8500:8500"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - backend

  notifications:
    image: nadea39/notification-service:v1.0.0
    container_name: notifications_container
    ports:
      - "8600:8600"
    environment:
      - PYTHONUNBUFFERED=1
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - SERVICE_DISCOVERY_URL=http://service_discovery:8500
    networks:
      - backend

  # HAProxy Load Balancer
  load-balancer:
    image: haproxy:2.8-alpine
    container_name: load-balancer
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - backend
    depends_on:
      - task-service
      - voting-service
      - user_service
      - game_service
      - townservice
      - characterservice
      - rumors-service
    restart: unless-stopped
    ports:
      - "8180:8180"
      - "8181:8181"
      - "8404:8404"

  # =============================
  # SHARDED REDIS CACHE CLUSTER
  # =============================

  gateway_cache_1:
    image: redis:7-alpine
    container_name: gateway_cache_1
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  gateway_cache_2:
    image: redis:7-alpine
    container_name: gateway_cache_2
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6380:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  gateway_cache_3:
    image: redis:7-alpine
    container_name: gateway_cache_3
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6381:6379"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # =============================
  # ELK Stack + Filebeat setup
  # =============================

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  logstash:
    image: docker.elastic.co/logstash/logstash:8.15.0
    container_name: logstash
    depends_on:
      - elasticsearch
    volumes:
      - ./elk/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
    ports:
      - "5044:5044"
      - "9600:9600"
    networks:
      - backend
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - backend
    restart: unless-stopped

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.15.0
    container_name: filebeat
    user: root
    command: ["--strict.perms=false"]
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./elk/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - filebeat_data:/usr/share/filebeat/data
    depends_on:
      - logstash
    networks:
      - backend
    restart: unless-stopped

  # =============================
  # GATEWAY SERVICE (Updated for sharding)
  # =============================

  gateway:
    build: .
    container_name: gateway_container
    ports:
      - "8000:8000"
    volumes:
      - //./pipe/docker_engine://./pipe/docker_engine
    environment:
      DOCKER_HOST: "npipe:////./pipe/docker_engine"
      TASK_SERVICE_URL: http://task-service:8180
      VOTING_SERVICE_URL: http://voting-service:8181
      GAME_SERVICE_URL: http://game_service:3005
      USER_SERVICE_URL: http://user_service:3000
      RUMORS_SERVICE_URL: http://rumors-service:8081
      SHOP_SERVICE_URL: http://shopservice:8085
      ROLEPLAY_SERVICE_URL: http://roleplayservice:8086
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      TOWN_SERVICE_URL: http://townservice:4001
      CHARACTER_SERVICE_URL: http://characterservice:4002
      # Sharded cache configuration
      CACHE_SHARD_URLS: redis://gateway_cache_1:6379,redis://gateway_cache_2:6379,redis://gateway_cache_3:6379
      CACHE_DEFAULT_TTL: 15
      VIRTUAL_NODES: 150
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN}
    depends_on:
      gateway_cache_1:
        condition: service_healthy
      gateway_cache_2:
        condition: service_healthy
      gateway_cache_3:
        condition: service_healthy
      load-balancer:
        condition: service_started
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/cache/stats"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:6
    container_name: mongo_container
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - backend

  user_service:
    image: nadea39/user-management-service:1.8
    deploy:
      replicas: 2
    environment:
      - MONGO_URI=${MONGO_URI_USER}
      - USE_MOCKS=true
      - PORT=3000
      - GAME_SERVICE_URL=${GAME_SERVICE_URL}
    depends_on:
      - mongo
    networks:
      - backend
    env_file:
      - .env

  game_service:
    image: nadea39/gameservice:v1.0.7
    deploy:
      replicas: 2
    environment:
      - MONGO_URI=${MONGO_URI_GAME}
      - PORT=${PORT}
      - NODE_ENV=${NODE_ENV}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
    depends_on:
      - mongo
      - user_service
    networks:
      - backend

  db_userm_populator:
    image: nadea39/user-management-service:1.0
    container_name: db_populator_container
    environment:
      - MONGO_URI=mongodb://mongo:27017/user_management
    depends_on:
      - mongo
    command: ["node", "src/populate-db.js"]
    restart: "no"

  db_game_populator:
    image: nadea39/gameservice:v1.0.2
    container_name: game_db_populator
    environment:
      - MONGO_URI=mongodb://mongo:27017/gameservice
    depends_on:
      - mongo
    command: ["node", "src/gameServicePopulator.js"]
    restart: "no"
    networks:
      - backend

  mongo-town:
    image: mongo:6
    container_name: mongo-town
    restart: unless-stopped
    ports:
      - "27019:27017"
    volumes:
      - mongo-town-data:/data/db
    networks:
      - backend

  townservice:
    image: livia994/townservice:latest
    deploy:
      replicas: 2
    restart: unless-stopped
    environment:
      - MONGO_URI=mongodb://mongo-town:27017/townDB
      - PORT=4001
      - NODE_ENV=production
    depends_on:
      - mongo-town
      - db_town_populator
    networks:
      - backend

  db_town_populator:
    image: livia994/townservice:3.0
    container_name: town_db_populator
    command: ["node", "src/db/seed/town-seed.js"]
    environment:
      - MONGO_URI=mongodb://mongo-town:27017/townDB
    depends_on:
      - mongo-town
    networks:
      - backend
    restart: "no"

  mongo-character:
    image: mongo:6
    container_name: mongo-character
    restart: unless-stopped
    ports:
      - "27018:27017"
    volumes:
      - mongo-character-data:/data/db
    networks:
      - backend

  characterservice:
    image: livia994/characterservice:latest
    deploy:
      replicas: 2
    restart: unless-stopped
    environment:
      - MONGO_URI=mongodb://mongo-character:27017/characterDB
      - PORT=4002
      - NODE_ENV=production
    depends_on:
      - mongo-character
      - db_character_populator
    networks:
      - backend

  db_character_populator:
    image: livia994/characterservice:1.10
    container_name: character_db_populator
    command: ["node", "src/db/seed/character-seed.js"]
    environment:
      - MONGO_URI=mongodb://mongo-character:27017/characterDB
    depends_on:
      - mongo-character
    networks:
      - backend
    restart: "no"

  postgres-voting:
    container_name: postgres-voting
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: voting_service
      PGDATA: /data/postgres
    volumes:
      - postgres-voting:/data/postgres
    ports:
      - "5442:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  postgres-task:
    container_name: postgres-task
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: task_service
      PGDATA: /data/postgres
    volumes:
      - postgres-task:/data/postgres
    ports:
      - "5443:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  voting-service:
    image: vladamusin/voting_service:0.0.7
    deploy:
      replicas: 2
    depends_on:
      postgres-voting:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-voting:5432/voting_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
    restart: unless-stopped

  task-proxy:
    image: nginx:alpine
    container_name: task-proxy
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/templates/nginx.conf.template:ro
    environment:
      INTERNAL_SERVICE_TOKEN: ${INTERNAL_SERVICE_TOKEN}
    networks:
      - backend
    depends_on:
      - gateway
    restart: unless-stopped

  task-service:
    image: vladamusin/task_service:0.0.18
    deploy:
      replicas: 2
    depends_on:
      postgres-task:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-task:5432/task_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      CHARACTER_SERVICE_URL: http://task-proxy:8000
    restart: unless-stopped

  postgres-shop:
    image: postgres:15
    container_name: postgres-shop
    environment:
      POSTGRES_USER: shopuser
      POSTGRES_PASSWORD: shoppass
      POSTGRES_DB: shop_service
    volumes:
      - shop-postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shopuser"]
      interval: 5s
      retries: 5
      start_period: 5s
    networks:
      - backend
    restart: unless-stopped

  shopservice:
    image: catalinaernu/shop-service:latest
    deploy:
      replicas: 2
    depends_on:
      postgres-shop:
        condition: service_healthy
      service_discovery:
        condition: service_healthy
    environment:
      ASPNETCORE_URLS: http://+:8085
      CONNECTION_STRING: Host=postgres-shop;Database=shop_service;Username=shopuser;Password=shoppass
      SERVICE_DISCOVERY_URL: http://service_discovery:8500
      SERVICE_NAME: shop-service
    volumes:
      - shop-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8085 || exit 1"]
      interval: 10s
      retries: 5
      start_period: 5s
    networks:
      - backend

  roleplayservice:
    image: catalinaernu/roleplay-service:latest
    deploy:
      replicas: 2
    depends_on:
      gateway_cache_1:
        condition: service_healthy
      service_discovery:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8086
      Redis__Config: gateway_cache_1:6379
      CacheDefaultTtl: 15
      SERVICE_NAME: roleplay-service
      SERVICE_DISCOVERY_URL: http://service_discovery:8500
    ports:
      - "8086:8086"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8086/health || exit 1"]
      interval: 10s
      retries: 5
      start_period: 5s
    networks:
      - backend

  postgres-rumors:
    container_name: postgres-rumors
    image: postgres:15
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "rumors_service"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-rumors:/var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d rumors_service"]
      interval: 5s
      retries: 5
      timeout: 5s

  rumors-service:
    image: drumdrum652/rumors-service:8.0
    deploy:
      replicas: 2
    depends_on:
      postgres-rumors:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-rumors:5432/rumors_service
      SPRING_DATASOURCE_USERNAME: "${POSTGRES_USER}"
      SPRING_DATASOURCE_PASSWORD: "${POSTGRES_PASSWORD}"
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    networks:
      - backend
    restart: unless-stopped

networks:
  backend:
    driver: bridge

volumes:
  elasticsearch_data:
    driver: local
  filebeat_data:
    driver: local
  mongo_data:
  mongo-town-data:
  mongo-character-data:
  postgres-voting:
  postgres-task:
  shop-postgres-data:
  postgres-rumors: