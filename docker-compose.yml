services:
  gateway:
    build: .
    container_name: gateway_container
    ports:
      - "8000:8000"
    environment:
      TASK_SERVICE_URL: http://task-service:8180
      VOTING_SERVICE_URL: http://voting-service:8181
      GAME_SERVICE_URL: http://game_service:3005
      USER_SERVICE_URL: http://user_service:3000
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      TOWN_SERVICE_URL: http://townservice:4001
      CHARACTER_SERVICE_URL: http://characterservice:4002
      CACHE_URL: redis://gateway_cache:6379
      CACHE_DEFAULT_TTL: 15

    depends_on:
      - task-service
      - voting-service
      - game_service
      - user_service
      - townservice
      - characterservice
      - gateway_cache
    networks:
      - backend

  gateway_cache:
    image: redis:7
    container_name: gateway_cache
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - backend

  mongo:
    image: mongo:6
    container_name: mongo_container
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - backend

  user_service:
    image: nadea39/user-management-service:1.7
    container_name: user_service_container
    environment:
      - MONGO_URI=${MONGO_URI_USER}
      - USE_MOCKS=true
      - PORT=3000
      - GAME_SERVICE_URL=${GAME_SERVICE_URL} 
    ports:
      - "3000:3000"
    depends_on:
      - mongo
    networks:
      - backend
    env_file:
      - .env

  game_service:
    image: nadea39/gameservice:v1.0.5
    container_name: gameservice_container
    environment:
      - MONGO_URI=${MONGO_URI_GAME}
      - PORT=${PORT}
      - NODE_ENV=${NODE_ENV}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
    ports:
      - "3005:3005"
    depends_on:
      - mongo
      - user_service
    networks:
      - backend

  db_userm_populator:
    image: nadea39/user-management-service:1.0
    container_name: db_populator_container
    environment:
      - MONGO_URI=mongodb://mongo:27017/user_management
    depends_on:
      - mongo
    command: ["node", "src/populate-db.js"]
    restart: "no"

  db_game_populator:
    image: nadea39/gameservice:v1.0.2
    container_name: game_db_populator
    environment:
      - MONGO_URI=mongodb://mongo:27017/gameservice
    depends_on:
      - mongo
    command: ["node", "src/gameServicePopulator.js"]
    restart: "no"
    networks:
      - backend

  # --- all the extra services from main branch ---
  mongo-town:
    image: mongo:6
    container_name: mongo-town
    restart: unless-stopped
    ports:
      - "27019:27017"
    volumes:
      - mongo-town-data:/data/db
    networks:
      - backend

  townservice:
    image: livia994/townservice:3.0
    container_name: townservice
    restart: unless-stopped
    ports:
      - "4001:4001"
    environment:
      - MONGO_URI=mongodb://mongo-town:27017/townDB
      - PORT=4001
      - NODE_ENV=production
    depends_on:
      - mongo-town
      - db_town_populator
    networks:
      - backend

  db_town_populator:
    image: livia994/townservice:3.0
    container_name: town_db_populator
    command: ["node", "src/db/seed/town-seed.js"]
    environment:
      - MONGO_URI=mongodb://mongo-town:27017/townDB
    depends_on:
      - mongo-town
    networks:
      - backend
    restart: "no"


  mongo-character:
    image: mongo:6
    container_name: mongo-character
    restart: unless-stopped
    ports:
      - "27018:27017"
    volumes:
      - mongo-character-data:/data/db
    networks:
      - backend

  characterservice:
    image: livia994/characterservice:1.10
    container_name: characterservice
    restart: unless-stopped
    ports:
      - "4002:4002"
    environment:
      - MONGO_URI=mongodb://mongo-character:27017/characterDB
      - PORT=4002
      - NODE_ENV=production
    depends_on:
      - mongo-character
      - db_character_populator
    networks:
      - backend

  db_character_populator:
    image: livia994/characterservice:1.10
    container_name: character_db_populator
    command: ["node", "src/db/seed/character-seed.js"]
    environment:
      - MONGO_URI=mongodb://mongo-character:27017/characterDB
    depends_on:
      - mongo-character
    networks:
      - backend
    restart: "no"

  postgres-voting:
    container_name: postgres-voting
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: voting_service
      PGDATA: /data/postgres
    volumes:
      - postgres-voting:/data/postgres
    ports:
      - "5442:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  postgres-task:
    container_name: postgres-task
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: task_service
      PGDATA: /data/postgres
    volumes:
      - postgres-task:/data/postgres
    ports:
      - "5443:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  voting-service:
    image: vladamusin/voting_service:0.0.4
    container_name: voting-service
    ports:
      - "8181:8181"
    depends_on:
      postgres-voting:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-voting:5432/voting_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
    restart: unless-stopped

  task-service:
    image: vladamusin/task_service:0.0.8
    container_name: task-service
    ports:
      - "8180:8180"
    depends_on:
      postgres-task:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-task:5432/task_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
    restart: unless-stopped


  postgres-shop:
    image: postgres:15
    container_name: postgres-shop
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB_SHOP}
      POSTGRES_USER: ${POSTGRES_USER_SHOP}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_SHOP}
    volumes:
      - pad_shop-postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - backend

  postgres-roleplay:
    image: postgres:15
    container_name: postgres-roleplay
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB_ROLEPLAY}
      POSTGRES_USER: ${POSTGRES_USER_ROLEPLAY}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_ROLEPLAY}
    volumes:
      - pad_roleplay-postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - backend

  shopservice:
    image: catalinaernu/shopservice:1.0
    container_name: shopservice
    restart: always
    depends_on:
      - postgres-shop
    environment:
      DOTNET_ENVIRONMENT: Development
      POSTGRES_CONNECTION: "Host=${POSTGRES_HOST_SHOP};Database=${POSTGRES_DB_SHOP};Username=${POSTGRES_USER_SHOP};Password=${POSTGRES_PASSWORD_SHOP}"
    ports:
      - "${SHOP_SERVICE_PORT}:80"
    networks:
      - backend

  roleplayservice:
    image: catalinaernu/roleplayservice:1.0
    container_name: roleplayservice
    restart: always
    depends_on:
      - postgres-roleplay
    environment:
      DOTNET_ENVIRONMENT: Development
      POSTGRES_CONNECTION: "Host=${POSTGRES_HOST_ROLEPLAY};Database=${POSTGRES_DB_ROLEPLAY};Username=${POSTGRES_USER_ROLEPLAY};Password=${POSTGRES_PASSWORD_ROLEPLAY}"
    ports:
      - "${ROLEPLAY_SERVICE_PORT}:80"
    networks:
      - backend


  postgres-rumors:
    container_name: postgres-rumors
    image: postgres:15
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "rumors_service"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-rumors:/var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d rumors_service"]
      interval: 5s
      retries: 5
      timeout: 5s

  communication-service:
    image: "${COMM_IMAGE}"
    container_name: communication-service
    ports:
      - "${COMM_PORT}:8080"
    networks:
      - backend
    restart: unless-stopped
    # optional healthcheck to ensure app started (adjust path if you have /actuator/health)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6

  rumors-service:
    image: "${RUMORS_IMAGE}"
    container_name: rumors-service
    ports:
      - "${RUMORS_PORT}:8081"
    depends_on:
      postgres-rumors:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-rumors:5432/rumors_service
      SPRING_DATASOURCE_USERNAME: "${POSTGRES_USER}"
      SPRING_DATASOURCE_PASSWORD: "${POSTGRES_PASSWORD}"
    restart: unless-stopped


  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    networks:
      - backend
    restart: unless-stopped



networks:
  backend:
    driver: bridge

volumes:
  mongo_data:
  mongo-town-data:
  mongo-character-data:
  postgres-voting:
  postgres-task:
  shop-postgres-data:
  roleplay-postgres-data:
  postgres-rumors:
  pad_shop-postgres-data:
  pad_roleplay-postgres-data:
